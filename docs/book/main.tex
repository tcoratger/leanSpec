%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lean Consensus: A Formal Specification
% Main Document
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{preamble}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Front Matter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\frontmatter

% Title page
\begin{titlepage}
\centering
\vspace*{3cm}

{\Huge\bfseries\color{ethblue} Lean Consensus}\\[1cm]
{\Large\color{leanpurple} A Formal Specification of\\Ethereum's Post-Quantum Protocol}\\[2cm]

\begin{tikzpicture}
    % Stylized blockchain logo
    \foreach \i in {0,1,2,3,4} {
        \node[
            rectangle,
            draw=ethblue,
            fill=softgray,
            minimum width=1.2cm,
            minimum height=0.8cm,
            rounded corners=2pt
        ] (b\i) at (\i*1.5, 0) {};
        \ifnum\i>0
            \draw[->, thick, ethblue] (b\the\numexpr\i-1\relax) -- (b\i);
        \fi
    }
    \node[finalized] at (b0) {};
    \node[justified] at (b1) {};
    \node[justified] at (b2) {};
\end{tikzpicture}

\vspace{3cm}

{\large Ethereum Foundation}\\[0.5cm]
{\large 2025}

\vfill

\end{titlepage}

% Table of contents
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Main Matter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\mainmatter

% Part I: Foundations
\part{Foundations}

\chapter{Introduction}
\label{ch:introduction}

\begin{abstract}
This book provides a comprehensive, educational treatment of the Lean Consensus
protocol---Ethereum's simplified consensus mechanism designed for testing
post-quantum cryptographic signatures. We explain not just the ``what'' but the
``why'' of each protocol component, building understanding from first principles.
\end{abstract}

\section{What is Lean Consensus?}

Lean Consensus is a minimal proof-of-stake consensus protocol designed to test
post-quantum signatures within the Ethereum ecosystem. It strips away the complexity
of the full Beacon Chain while preserving the essential consensus mechanisms:

\begin{itemize}
    \item Block proposal and validation
    \item Attestation-based voting
    \item Casper FFG-style justification and finalization
    \item LMD-GHOST fork choice
\end{itemize}

\section{Design Philosophy}

The protocol follows several key principles:

\begin{enumerate}
    \item \textbf{Simplicity}: Remove all features not essential for consensus testing
    \item \textbf{Clarity}: Each rule should have an obvious purpose
    \item \textbf{Correctness}: Security properties must be provable
    \item \textbf{Compatibility}: Maintain conceptual alignment with Ethereum's Beacon Chain
\end{enumerate}

\section{Book Structure}

This book is organized into three parts:

\begin{description}
    \item[Part I: Foundations] introduces the basic concepts and time model
    \item[Part II: Block Processing] covers state transitions and attestations
    \item[Part III: Fork Choice] explains how the canonical chain is selected
\end{description}

% Chapter 2 would go here (prerequisites/background)
% Chapter 3 would go here (time model)

% Part II: Block Processing
\part{Block Processing}

% Include Chapter 4
\input{chapter4_block_processing}

% Part III would continue with fork choice, etc.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Back Matter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\backmatter

\chapter{Glossary}

\begin{description}
    \item[Attestation] A validator's signed vote for a chain view, containing
        source, target, and head checkpoints.

    \item[Block] A data structure containing a header and body that proposes
        state changes to the chain.

    \item[Checkpoint] A pair of (block root, slot) used as a reference point
        for justification and finalization.

    \item[Finalization] The irreversible confirmation of a block, requiring a
        continuous chain of justified checkpoints.

    \item[Fork Choice] The algorithm for selecting the canonical chain head
        when multiple valid chains exist.

    \item[Genesis] The initial state from which the chain begins, serving as
        the trust anchor for all subsequent consensus.

    \item[Justification] A block becomes justified when it receives attestations
        from $\geq 2/3$ of validators.

    \item[LMD-GHOST] Latest Message Driven Greediest Heaviest Observed SubTree,
        the fork choice rule used in Ethereum.

    \item[Proposer] The validator assigned to create a block for a particular slot.

    \item[Slot] A fixed time interval (4 seconds in Lean Consensus) during which
        one block may be proposed.

    \item[State] The complete snapshot of all protocol data at a given point in time.

    \item[Supermajority] A threshold of $\geq 2/3$ of validators, required for
        justification.

    \item[Validator] A participant in the consensus protocol who proposes blocks
        and creates attestations.

    \item[XMSS] eXtended Merkle Signature Scheme, a post-quantum signature algorithm
        used in Lean Consensus.
\end{description}

\end{document}
