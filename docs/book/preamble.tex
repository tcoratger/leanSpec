%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lean Consensus Book - Preamble
% Common style definitions and package imports
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Document class
\documentclass[11pt, letterpaper, twoside]{book}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Typography and fonts
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{microtype}

% Mathematics
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}

% Graphics and diagrams
\usepackage{tikz}
\usetikzlibrary{
    arrows.meta,
    calc,
    decorations.pathreplacing,
    decorations.pathmorphing,
    fit,
    positioning,
    shapes.geometric,
    shapes.misc,
    backgrounds,
    chains,
    matrix
}

% Algorithms
\usepackage{algorithm}
\usepackage{algorithmic}

% Colors
\usepackage{xcolor}

% Tables
\usepackage{booktabs}
\usepackage{array}

% Hyperlinks
\usepackage{hyperref}

% Code listings
\usepackage{listings}

% Geometry
\usepackage[margin=1in]{geometry}

% Headers and footers
\usepackage{fancyhdr}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Color Definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Primary colors - Ethereum/Lean branding
\definecolor{ethblue}{RGB}{28, 90, 168}
\definecolor{leanpurple}{RGB}{102, 51, 153}
\definecolor{softgray}{RGB}{245, 245, 250}

% Secondary colors for diagrams
\definecolor{successgreen}{RGB}{40, 167, 69}
\definecolor{warningyellow}{RGB}{255, 193, 7}
\definecolor{dangerred}{RGB}{220, 53, 69}
\definecolor{infocyan}{RGB}{23, 162, 184}

% Code colors
\definecolor{codebackground}{RGB}{248, 248, 248}
\definecolor{codecomment}{RGB}{106, 153, 85}
\definecolor{codestring}{RGB}{163, 21, 21}
\definecolor{codekeyword}{RGB}{0, 0, 255}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Custom Environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Information box environment
\newenvironment{infobox}[1]{%
    \begin{center}
    \begin{tikzpicture}
    \node[
        rectangle,
        draw=ethblue,
        fill=softgray,
        rounded corners=5pt,
        inner sep=12pt,
        text width=0.85\textwidth,
        align=justify
    ] (box) \bgroup
    \textbf{\color{ethblue}#1}\par\smallskip
}{%
    \egroup;
    \end{tikzpicture}
    \end{center}
}

% Definition environment
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}

% Example environment
\newtheorem{example}{Example}[chapter]

% Remark environment
\theoremstyle{remark}
\newtheorem{remark}{Remark}[chapter]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TikZ Styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Common node styles
\tikzset{
    % Basic box style
    basicbox/.style={
        rectangle,
        draw=ethblue,
        fill=softgray,
        minimum width=2cm,
        minimum height=0.8cm,
        font=\small,
        rounded corners=3pt
    },
    % Block style (for blockchain blocks)
    block/.style={
        rectangle,
        draw=ethblue,
        fill=softgray,
        minimum width=1.5cm,
        minimum height=1cm,
        font=\small
    },
    % Justified block
    justified/.style={
        block,
        draw=leanpurple,
        fill=leanpurple!20
    },
    % Finalized block
    finalized/.style={
        block,
        draw=successgreen,
        fill=successgreen!20
    },
    % State node
    statenode/.style={
        rectangle,
        draw=ethblue,
        fill=white,
        minimum width=3cm,
        minimum height=2cm,
        rounded corners=5pt
    },
    % Arrow styles
    chainlink/.style={
        ->,
        thick,
        gray
    },
    votelink/.style={
        ->,
        dashed,
        ethblue,
        thick
    },
    % Decision diamond
    decision/.style={
        diamond,
        draw=leanpurple,
        fill=leanpurple!10,
        minimum width=1.5cm,
        aspect=2,
        font=\small
    }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Code Listing Style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\lstdefinestyle{pythonstyle}{
    language=Python,
    basicstyle=\ttfamily\small,
    backgroundcolor=\color{codebackground},
    commentstyle=\color{codecomment},
    keywordstyle=\color{codekeyword}\bfseries,
    stringstyle=\color{codestring},
    numbers=left,
    numberstyle=\tiny\color{gray},
    numbersep=8pt,
    frame=single,
    framerule=0.5pt,
    rulecolor=\color{gray!50},
    breaklines=true,
    showstringspaces=false,
    tabsize=4
}

\lstset{style=pythonstyle}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hyperref Configuration
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\hypersetup{
    colorlinks=true,
    linkcolor=ethblue,
    citecolor=leanpurple,
    urlcolor=ethblue,
    pdftitle={Lean Consensus: A Formal Specification},
    pdfauthor={Ethereum Foundation},
    pdfsubject={Blockchain Consensus Protocols}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Page Style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[LO]{\nouppercase{\rightmark}}
\fancyhead[RE]{\nouppercase{\leftmark}}
\renewcommand{\headrulewidth}{0.4pt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Chapter Style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{titlesec}

\titleformat{\chapter}[display]
{\normalfont\huge\bfseries\color{ethblue}}
{\chaptertitlename\ \thechapter}
{20pt}
{\Huge}

\titleformat{\section}
{\normalfont\Large\bfseries\color{ethblue}}
{\thesection}
{1em}
{}

\titleformat{\subsection}
{\normalfont\large\bfseries\color{leanpurple}}
{\thesubsection}
{1em}
{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Abstract Environment for Chapters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewenvironment{abstract}{%
    \begin{center}
    \begin{tikzpicture}
    \node[
        rectangle,
        draw=leanpurple,
        fill=leanpurple!5,
        rounded corners=8pt,
        inner sep=15pt,
        text width=0.9\textwidth,
        align=justify
    ] (abstractbox) \bgroup
    \itshape
}{%
    \egroup;
    \end{tikzpicture}
    \end{center}
    \vspace{1em}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Custom Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Inline code
\newcommand{\code}[1]{\texttt{#1}}

% Emphasis for protocol terms
\newcommand{\term}[1]{\textit{#1}}

% Block hash notation
\newcommand{\blockhash}[1]{\mathcal{H}(#1)}

% State transition
\newcommand{\transition}[2]{#1 \xrightarrow{\text{block}} #2}

% Supermajority threshold
\newcommand{\supermajority}{\frac{2}{3}n}

% Validator set
\newcommand{\validators}{\mathcal{V}}

% Checkpoint notation
\newcommand{\checkpoint}[2]{\langle #1, #2 \rangle}
